<!doctype html>
<html>
  <head>
    <title>Music</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>

    
  </head>

  <body>
    <div class="container">
      <div id="login">
        <h1>Music</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
      </div>
      <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">

    </script>
    <div class="container" id="track">
    <div class="row header-padding mb-5">
      <h1>Cerca la tua canzone</h1>
      <p>Metti il nome della canzone e clicca su "Cerca". 
        <br>Poi, Clicca sulle immagini per ascoltare 30 secondi della canzone.
        <br>Per maggiori Informazioni clicca su "Avanzate"</p>
      <form id="search-form" class="search-row " style="margin-bottom: 20px;">
        <div class="input-group">
          <span class="input-group-btn">
            <input type="button" id="advanced-button" class="btn btn-default my-input-title" value="Avanzate"/>
          </span>
          <input type="text" id="query" value="" class="form-control" placeholder="Nome della canzone"/>
          <span class="input-group-btn">
            <input type="submit" id="search" class="btn btn-primary" value="Cerca"/>
          </span>
        </div>
        <div id="advanced-form" style="display:none">
          <div class="input-group">
            <span class="input-group-addon my-input-title" id="basic-addon3">Artista</span>
            <input type="text" id="artist-query" value="" class="form-control" placeholder="Nome artista"/>
          </div>
          <div class="input-group">
            <span class="input-group-addon my-input-title" id="basic-addon3">Album</span>
            <input type="text" id="album-query" value="" class="form-control" placeholder="Album"/>
          </div>
          <div class="input-group">
            <span class="input-group-addon my-input-title" id="basic-addon3">Genere</span>
            <input type="text" id="genre-query" value="" class="form-control" placeholder="Genere"/>
          </div>
          <div class="input-group">
            <span class="input-group-addon my-input-title" id="basic-addon3">Anno</span>
            <input type="text" id="year-query" value="" class="form-control" placeholder="Anno"/>
          </div>
        </div>
      </form>
    </div>
    <div id="results" class="row"></div>
    <nav>
      <ul id="pager" class="pager btn-lg">
        <li id="prevPage" style="display:none"><a href="#">Indietro</a></li>
        <li id="nextPage" style="display:none"><a href="#">Avanti</a></li>
      </ul>
    </nav>
  </div>

   

    <script id="oauth-template" type="text/x-handlebars-template">

    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      
      var audioObject = null;
      var onAirClass = "onAir";
      var songListClass = "songList";
      var searchTerm = null;
      var curOffset = 0;
      var limitPerPage = 10;
      var hasNext = false;
      var hasPrev = false;
      var hasAdvancedSearch = false;

      $(document).ready(function(){
        var $search = $("#search-form");
        var $song = $search.find("#query");
        var $artist = $search.find("#artist-query");
        var $album = $search.find("#album-query");
        var $genre = $search.find("#genre-query");
        var $year = $search.find("#year-query");
        $search.submit(function(e) {
          curOffset = 0;
          hasNext = false;
          e.preventDefault();
          searchTerm = '"' + $song.val() + '"';
          if (hasAdvancedSearch) {
            if ($album.val().length > 0) {
              searchTerm += ' album:"' + $album.val() + '"';
            }
            if ($artist.val().length > 0) {
              searchTerm += ' artist:"' + $artist.val() + '"';
            }
            if ($genre.val().length > 0) {
              searchTerm += ' genre:"' + $genre.val() + '"';
            }
            if ($year.val().length > 0) {
              if (!isNaN($year.val())) {
                searchTerm += ' year:' + $year.val();
              } else {
                alert("invalid year, ignored this field.");
              }
            }
          }
          console.log(searchTerm);
          searchTrack(searchTerm);
        });
        $("#nextPage").click(function(){
          curOffset += limitPerPage;
          console.log("next offset" + curOffset);
          searchTrack(searchTerm);
        });
        $("#prevPage").click(function(){
          curOffset -= limitPerPage;
          console.log("prev offset" + curOffset);
          searchTrack(searchTerm);
        });
        $("#advanced-button").click(function(){
          if (hasAdvancedSearch) {
            $("#advanced-form").slideUp();
          } else {
            $("#advanced-form").slideDown();
          }
          hasAdvancedSearch = !hasAdvancedSearch;
        });
      });

      var searchTrack = function(query) {
        if (audioObject != null) {
          audioObject.pause();
        }
        $.ajax({
          url: 'https://api.spotify.com/v1/search',
          data: {
            q: query,
            type: 'track',
            limit: limitPerPage,
            offset: curOffset
          },
          headers: {
                    'Authorization': 'Bearer ' + access_token
          },
          success: function (response) {
            hasNext = (curOffset + limitPerPage) < response.tracks.total;
            hasPrev = (curOffset - limitPerPage) >= 0;
            handleTrackResponse(response);
          }
        });
      };

      var handleTrackResponse = function(response) {

        console.log(response);
        var $results = $("#results");
        $results.html(layoutSongList(response.tracks.items));
        $("." + songListClass).click(playSong);
        if (hasNext) {
          $("#nextPage").show();
        } else {
          $("#nextPage").hide();
        }
        if (hasPrev) {
          $("#prevPage").show();
        } else {
          $("#prevPage").hide();
        }
      }

      // Input is the song items, and output is layed out html source
      var layoutSongList = function(songItems) {
        var htmlText = "";
        for (var i = 0; i < songItems.length; ++i) {
          var cur = songItems[i];
          //console.log(cur);
          var songName = cur.name;
          var artistName = "Unkonwn";
          if (cur.artists.length > 0) {
            artistName = cur.artists[0].name;
          }
          var imgUrl = "";
          if (cur.album.images.length > 0) {
            imgUrl = cur.album.images[0].url;
          }
          var preview = cur.preview_url;
          htmlText += '<div class=" col-lg-4 col-sm-6 text-center cover songList" data-preview="' + preview + '"><img id="cover-img" class="img  img-responsive img-center" src="'+ imgUrl +'" alt=""><h4>'+ songName +'<small><br>'+ artistName +'</small></h4></div>';
        }
        return htmlText;
      }

      var playSong = function() {
        if (audioObject != null) {
          audioObject.pause();
        }
        if ($(this).find("#cover-img").hasClass(onAirClass)) {
          $(this).find("#cover-img").removeClass(onAirClass);
          return;
        }
        $(this).parent().find("." + onAirClass).removeClass(onAirClass);
        var previewUrl = $(this).attr("data-preview");
        audioObject = new Audio(previewUrl);
        audioObject.play();
        $(this).find("#cover-img").addClass(onAirClass);
}


      var access_token;

      (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }



        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();

        access_token = params.access_token;
        var refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            // render oauth info
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();

                }
            });
            $('#track').show();
          } else {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
              $('#track').hide();
              
          }

        }
      })();
    </script>
  </body>
</html>
